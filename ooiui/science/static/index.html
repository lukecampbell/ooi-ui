<!doctype html>
<html lang="en">
<head>      
    <title>OOI Science Page</title> 
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Main Landing Page For Science page">
    <meta name="author" content="RPS ASA">  
    <meta charset="UTF-8">

    <script src="/components/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="/components/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
    

    <link rel="stylesheet" href="/components/leaflet/dist/leaflet.css"/>
    <script src="/components/leaflet/dist/leaflet.js"></script>
    

    <script src="/components/d3/d3.min.js"></script>
    
    <link href="/components/font-awesome/css/font-awesome.min.css" rel="stylesheet">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="/components/bootstrap/dist/js/bootstrap.min.js"></script>
     
    <link rel="stylesheet" href="/components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css">
    <script src="/components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.js"></script>


    <link rel="stylesheet" href="/css/index.css">
    <script src="/js/ooi/map.js"></script>

    <!--   
    marker cluster
    -->
    <script src="/components/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="/components/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="/components/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <!--
    Date Time
    -->    
    <link rel="stylesheet" href="/components/bootstrap3-datetimepicker/build/css/bootstrap-datetimepicker.min.css">
    <script src="/components/moment/moment.js"></script> 
    <script src="/components/bootstrap3-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script> 

    <script src="/js/ooi/plot.js"></script> 
    <link rel="stylesheet" href="/css/ooi/plot.css">

    <!--
    TOC MENU    
    -->        
    <link href="/components/fancytree/dist/skin-bootstrap/ui.fancytree.css" rel="stylesheet" type="text/css" class="skinswitcher">

    <script src="/components/fancytree/dist/src/jquery.fancytree.js" type="text/javascript"></script>
    <script src="/components/fancytree/dist/src/jquery.fancytree.edit.js" type="text/javascript"></script>
    <script src="/components/fancytree/dist/src/jquery.fancytree.glyph.js" type="text/javascript"></script>
    <script src="/components/fancytree/dist/src/jquery.fancytree.wide.js" type="text/javascript"></script>
    <script src="/components/fancytree/dist/src/jquery.fancytree.filter.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/css/toc_menu.css" />
    <script src="/js/ooi/toc_menu.js"></script>

</head>

<style>


</style>


<body>

    <!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="http://erddap.ooi.rutgers.edu/erddap/info/index.html"><span class="glyphicon glyphicon-hdd" aria-hidden="true"></span> Data Catalog</a></li>            

            <li class="dropdown">               
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Array List <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li class="dropdown-header">Pioneer</li>
                <li><a href="/pioneer/">Array Overview</a></li>               
                <li class="divider"></li>
                <li class="dropdown-header">Other</li>
                <!--
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>
                -->
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <!--
            <div class="col-sm-4" style="padding-top:8px">
                <li>
                    <a class="btn btn-social-icon btn-twitter">
                        <i class="fa fa-twitter"></i>
                    </a>
                </li>
            </div>
            <div class="col-sm-4" style="padding-top:8px">
                <li>
                    <a class="btn btn-social-icon btn-facebook">
                        <i class="fa fa-facebook"></i>
                    </a>
                </li>
            </div>
            -->
            <!--
            <li><a href="../navbar/">Default</a></li>
            <li><a href="../navbar-static-top/">Static top</a></li>
            <li class="active"><a href="./">Fixed top</a></li>
            -->
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div id="wrapper">
    <div class="container-full">
        <!--/.banner -->
        <div class="row">       
            <div class="col-lg-4">
                <img src="/img/nsf-logo.png" class="img-rounded" style="width:100px;height:100px">
            </div>

            <div class="text-center">
                <div class="col-lg-4">
                    <img src="/img/OOI_BannerNew_01.png" class="img-rounded">
                </div>
            </div>

            <div class="col-lg-4"> 
                <div class="pull-right">
                    <img src="/img/OceanLeadershipLogoCS2.png" class="img-rounded" style="width:150px;height:100px">            
                </div>
            </div>
        </div>

        <!--/.Array Names -->
        <div class="row ">
            <div class="col-lg-12">
                <div class="panel">   <!-- removed panel-default-->
                  <div class="array-row">  <!-- removed panel-body-->
                    <div class="text-center">
                    <div class="btn-group btn-group">
                        <button type="button" class="active btn btn-info array-btn" array="all">All</button>
                        <button type="button" class="btn btn-default array-btn" array="ce" disabled="disabled">Endurance Array (CE)</button>
                        <button type="button" class="btn btn-default array-btn" array="gp" disabled="disabled">Station PAPA (GP)</button>
                        <button type="button" class=" btn btn-default array-btn" array="cp">Pioneer Array (CP)</button>
                        <button type="button" class="btn btn-default array-btn" array="ga" disabled="disabled">Global Argentine (GA)</button>
                        <button type="button" class="btn btn-default array-btn" array="rs" disabled="disabled">RS Regional (RS)</button>
                        <button type="button" class="btn btn-default array-btn" array="gi" disabled="disabled">Global Irminger Sea (GI)</button>
                        <button type="button" class="btn btn-default array-btn" array="gs" disabled="disabled">55 South (GS)</button>
                        <button type="button" class="btn btn-default array-btn" array="ssf" disabled="disabled">Shore Side Facilities (SSF)</button>
                    </div>
                    </div>
                  </div>
                </div>
            </div>
        </div>

        <!--/.content -->
        <div class="row">
            <div class="col-lg-4">
                <div class="panel panel-default">
                  <div class="panel-body" style="padding:1px;">
                    <div>                       

                        <h4 style="text-align: center;">Array Overview 
                            <i class="glyphicon glyphicon-info-sign info-icon"></i>
                        </h4>   

                        <div style="padding:5px;" class="col-1 input-group">
                               <div class="right-inner-addon">
                                   <input id="searchQuery" type="Search" placeholder="Search..." class="form-control" />
                                   <i class="glyphicon glyphicon-search"></i>                               
                                </div>
                                   <div class="input-group-btn">
                                       <button id="search-reset" type="button" class="btn btn-info">
                                            <span class="glyphicon glyphicon-remove-sign"></span>
                                       </button>
                                   </div>
                        </div>
                                    
                        <!--
                        <div style="padding:5px">
                            <div id="statusfilter" class="btn-group">
                                <button filtertype="status" filter="all" class="active filterMapBtn btn btn-info btn-sm" type="button">
                                  All
                                </button>

                                <button filtertype="status" filter="na" class="filterMapBtn btn btn-primary btn-sm" type="button">
                                  NA
                                </button>

                                <button filtertype="status" filter="on" class="filterMapBtn btn btn-success btn-sm" type="button">
                                  ON
                                </button>

                                <button filtertype="status" filter="off" class="filterMapBtn btn btn-danger btn-sm" type="button">
                                  OFF
                                </button>
                            </div>  
                        </div>                  
                        -->
                       
                        <div id="tocmenusection" class="toc-panel">                         
                        </div>

                        <!--                                                 
                        <h4 style="padding-top:20px;text-align: center;">Array Breakdown 
                            <i class="glyphicon glyphicon-info-sign info-icon"></i>
                        </h4>
                        
                        <div id="donut-example" style="text-align: center;">
                        </div>   
                        -->   
                    </div>
                  </div>
                </div>
            </div>
            
            <div class="col-lg-8 fill">
                <div class="panel panel-default" style="height: 100%">
                  <div class="panel-body" style="height: 100%;padding:5px;">
                    <div id="map" style="width: 100%; min-height: 400px;height:500px;"></div>
                  </div>
                </div>
            </div>

            <div class="bottom-div col-lg-12">
                <div class="panel panel-default" style="height: 100%">
                  <div class="panel-body" style="height: 100%;padding:5px;">
                        
                        <div class="col-lg-3" style="display: inline-block;">
                            <h4>Station Info</h4>

                            <dl class="dl-horizontal">
                                <dt>Array</dt>
                                  <dd id="currentArray"></dd>
                            </dl>

                            <dl class="dl-horizontal">
                                <dt>Platform</dt>
                                  <dd id="currentPlatform"></dd>
                            </dl>

                            <dl class="dl-horizontal">
                                <dt>Intrument</dt>
                                  <dd id="currentInstrument"></dd>
                            </dl>                           
                        </div>

                        <div class="col-lg-3" style="display: inline-block;">
                            <h4>Plot Controls</h4>
                            <div class="col-lg-2" style="width:100%;">
                                <select id="stream-select"class="form-control">                                                                                                                                             
                                </select>
                            </div>

                            <div class="col-lg-2" style="padding-top:10px;padding-bottom:10px; width:100%;">
                                <select id="variable-select"class="form-control">                                                                                                          
                                    <option value="m_present_secs_into_mission">m_present_secs_into_mission</option>
                                    <option value="sci_water_cond">sci_water_cond</option>                            
                                    <option value="sci_water_temp">sci_water_temp</option>
                                    <option value="sci_water_pressure">sci_water_pressure</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-lg-6" style="display: inline-block;">
                            <h4>Date Controls</h4>
                            <div class="col-lg-8" style="width:100%;">
                               <div class='col-md-5'>
                                    <div class="form-group">
                                        <div class='input-group date' id='datetimepicker_from'>
                                            <input type='text' class="form-control" />
                                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class='col-md-5'>
                                    <div class="form-group">
                                        <div class='input-group date' id='datetimepicker_to'>
                                            <input type='text' class="form-control" />
                                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>                       
                  </div>
                </div>
            </div>

            <div class="col-lg-12 bottom-div">
                <div class="panel panel-default">
                    <div class="panel-body" style="padding:5px;">     

                    <div id="processing-icon" class="spinner">
                      <div class="dot1"></div>
                      <div class="dot2"></div>
                    </div>                                       

                    <div class="container-fluid" id="plotting" style="display: none;width: 100%; min-height: 300px;height:300px;">  
                                        
                    </div>
                  </div>
                </div>
            </div>
            
        </div>
    </div>
    </div>

    <div id="tilepopovertitle" style="display: none">
            <b>Array Overview</b>
    </div> 

    <div id="tilepopovercontent" style="display: none">
            <div class="popovertext">
                some content here
            </div>
    </div> 

    <script>
    /* TEMPO ARRAY LIST*/
    array_list = {}
    array_list_all ={'lat':41.505,'lon':-80.09,"zoom":3}
    array_list['ce']={'name':'Endurance Array (CE)',"num":14,'lat':44.37,'lon':-124.95,"zoom":3}
    array_list['gp']={'name':'Station PAPA (GP)',"num":6,'lat':49.9795,'lon':-144.254,"zoom":3}
    array_list['cp']={'name':'Pioneer Array (CP)',"num":16,'lat':40.1,'lon':-70.88,"zoom":8}
    array_list['ga']={'name':'Global Argentine (GA)','num':7,'lat':-42.5073,'lon':-42.8905,"zoom":3}
    array_list['rs']={'name':'RS Regional','num':11,'lat':44.554,'lon':-125.352,"zoom":3}
    array_list['gi']={'name':'Global Irminger Sea (GI)','num':7,'lat':60.4582,'lon':-38.4407,"zoom":3}
    array_list['gs']={'name':'55 South (GS)','num':7,'lat':-54.0814,'lon':-89.6652,"zoom":3}
    array_list['gs']={'name':'55 South (GS)','num':7,'lat':-54.0814,'lon':-89.6652,"zoom":3}

    var map = L.map('map',{
        center: [41.505, -80.09],
        zoom: 3,
        maxZoom: 10
    });

    setupTileLayers(map)    

    var markers = new L.MarkerClusterGroup();    

    L.MarkerClusterGroup.include({ 

        resetMarkers: function (filter) {            
            var new_markers = Array();                        
            for (var i = 0; i < this._marker_list.length; i++) {      
                marker = this._marker_list[i]
                status = marker.options.status
                if (filter == "all"){
                    new_markers.push(marker);
                }
                else if (status == filter){
                    new_markers.push(marker);
                }
            }
            this.clearLayers();
            this.addLayers(new_markers);
            this.setfilteredMarkers(new_markers)
        },
        setfilteredMarkers: function (filteredMarkers) {
            this._filtered_marker_list = filteredMarkers;
        },    

        setMarkers: function (marker_list) {
            this._marker_list = marker_list;
            this.setfilteredMarkers(marker_list)            
        },

        filter: function (filter,filterType) {            
            //f = f || function (m) { return true; }                                         
            var new_markers = Array();           

            for (var i = 0; i < this._filtered_marker_list.length; i++) {
                marker = this._marker_list[i]
                status = marker.options.status
                platform = marker.options.platform
                instrument = marker.options.instrument                                                

                if (filter == "all"){                    
                    this.resetMarkers();
                }else{
                    if (filterType == "status"){                    
                        if (status == filter){
                            new_markers.push(marker);
                    }

                    }else if (filterType == "platform"){                                  
                        if (platform == filter){
                            new_markers.push(marker);
                        }
                    }else if (filterType == "instrument"){                    
                        if (instrument == filter){
                            new_markers.push(marker);
                        }
                    }
                }
            };
            this.setfilteredMarkers(new_markers)
            this.clearLayers();
            this.addLayers(new_markers);            
        }    
    });

    addMarkers(map,markers);

    /*
    USED FOR STATUS
    */
    function getStatusFilter(){
        return "all"
        //return $('#statusfilter').find( '.active' ).attr( "filter" )         
    }

     /* DONUT PLOT
    donutData = []
    total = 0
    arrayKeys = Object.keys(array_list)
    for (var i = 0; i < arrayKeys.length; i++) {
        total+= array_list[arrayKeys[i]]['num']
        donutRow = {label: array_list[arrayKeys[i]]['name'], value: array_list[arrayKeys[i]]['num']}
        donutData.push(donutRow)
    };
    donutRow = {label: 'All Platforms', value: total}
    donutData.push(donutRow)
    
    Morris.Donut({
      element: 'donut-example',
      data: donutData,
      resize: true
    });
    */

    /* USED FOR STATUS
    $('.filterMapBtn').on('click', function (e) {
        //Filter map by options        
        $(this).addClass('active').siblings().removeClass('active');        
        markers.resetMarkers(getStatusFilter());        
    });
    */
    

    
    $('#tocmenusection').on('click', function (e) {
        //Filter map by TOC
                
            
        var node = $("#tocmenusection").fancytree("getActiveNode");
        if ((typeof(node) !== 'undefined') && (node !== null)) {
            node_name = node.title
            //gets the node list 
            var ll = node.getParentList(includeRoot=false, includeSelf=false)
            /*
            for (var i = 0; i < ll.length; i++) {
                console.log(ll[i].title)
            };
            */

            //allow filtering at different levels
            request_level = node.getLevel()
            if (request_level == 1){
                //platform
                filterType="platform"
                filter = node_name
            }else if (request_level == 2){
                //instrument
                filterType="instrument"
                filter = node_name
            }else if (request_level == 3){
                //stream = instrument
                filterType="instrument"
                filter = ll[1].title
            }else if (request_level == 4){
                //parameter = instrument
                filterType="instrument"
                filter = ll[1].title
            }

            //reset the filters
            markers.resetMarkers(getStatusFilter());    
            //apply the marker filter                            
            markers.filter(filter,filterType);
        }
    });
    

    $('.array-btn').on('click', function (e) {
        
        var array = $( this ).attr( "array" )       

        $(this).addClass('active').siblings().removeClass('active');

        
        if (array == "all"){
            lat  = array_list_all['lat']
            lon  = array_list_all['lon']          
            zoom = array_list_all['zoom']
        } else{
            lat = array_list[array]['lat']
            lon = array_list[array]['lon']          
            zoom = array_list[array]['zoom']
        }      
        map.setView([lat, lon], zoom);   

    });

    $('.info-icon').popover({
        trigger: "hover",
        html:true,
        placement:'bottom',
        content: function() {
          return $('#tilepopovercontent').html();
        },
        title: function() {
          return $('#tilepopovertitle').html();
        }
    });
    
    $( document ).ready(function() {
        $( "#searchQuery" ).keyup(function() {
            match = $( "#searchQuery" ).val()
            var tree = $("#tocmenusection").fancytree("getTree");            
            n = tree.filterNodes(match, false);
        }); 


        $( "#search-reset" ).on('click',function(){
            var tree = $("#tocmenusection").fancytree("getTree");
            $( "#searchQuery" ).val("")
            tree.clearFilter();

            try{
                var node = $("#tocmenusection").fancytree("getActiveNode");
                node.setActive(false);
            }
            catch(err) {
            }
            //reset the map marker filters
            markers.resetMarkers(getStatusFilter());   
        });    
    });
    
    $('#map').on('click', '.popup-map-btn-download', function() {
        $('.popup-map-btn-plot').click();
        var array = $( this ).parent().attr( "array" ) 
        var instrument = $( this ).parent().attr( "instrument" )
        var platform = $( this ).parent().attr( "platform" )
        var node = $("#tocmenusection").fancytree("getActiveNode");
        var stream = $('#stream-select option:selected').text();



        instrument = instrument.replace(/-/g, '_');
        console.log(instrument);
        var url = '/erddap/tabledap/' + instrument + '_' + stream + '.nc';
        console.log(url);
        window.open(url, '_blank');
        //http://erddap.ooi.rutgers.edu/erddap/tabledap/CP05MOAS_GL001_03_CTDGVM000_ctdgv_m_glider_instrument_recovered_unprocessed.nc?m_present_time,sci_water_cond,sci_m_present_secs_into_mission,sci_water_temp,preferred_timestamp,m_present_secs_into_mission,sci_water_pressure,sci_m_present_time,internal_timestamp,time,sci_ctd41cp_timestamp,driver_timestamp&time>=2014-04-10T00:00:00Z&time<=2014-04-17T17:50:39Z




    });

    $('#stream-select').change(function() {
        console.log("Yo ma amigo");
        var stream = $('#stream-select option:selected').text();
        var array = $( "#currentArray" ).text();
        var platform = $( "#currentPlatform" ).text();
        var instrument = $( "#currentInstrument" ).text();      
        var node = $("#tocmenusection").fancytree("getActiveNode");
        console.log(instrument);



        var r_node = $("#tocmenusection").fancytree("getRootNode");        
        var f_node = r_node.findFirst(instrument)

        console.log(f_node)
        $( "#variable-select" ).empty();
        global_f_node = f_node;


        if (f_node.getChildren().length>0){
            for (var i = 0; i < f_node.getChildren().length; i++) {
                var streamSomething = f_node.getChildren()[i].title;
                console.log("streamSomething", streamSomething);
                console.log("stream", stream);
                console.log("I'm out of ideas!");
                 console.log(f_node.getChildren()[i].title);
                if (streamSomething == stream){
                    param_list = f_node.getChildren()[i].getChildren()
                    for (var j = 0; j < param_list.length; j++) {
                        if (param_list[j].title.indexOf("time") == -1){
                          $( "#variable-select" ).append('<option value="'+param_list[j].title+'">'+param_list[j].title+'</option>')
                        }
                    };
                } 
            };
        }


        updateData(array,platform,instrument); 
    });

    /*
    when you click on the map, select a point and click plot....
    */
    //when plot is click .... .popup-map-btn-plot
    $('#map').on('click', '.popup-map-btn-plot', function() {
        console.log("map-click")

        var array = $( this ).parent().attr( "array" ) 
        var instrument = $( this ).parent().attr( "instrument" )
        var platform = $( this ).parent().attr( "platform" )
        var node = $("#tocmenusection").fancytree("getActiveNode");


        if ((typeof(node) !== 'undefined') && (node !== null)) {
            if (node.getLevel() >= 3){
                //used for selection of stream
                console.log(array,instrument,platform)
                console.log(node.getLevel())
            } 
        }

        var r_node = $("#tocmenusection").fancytree("getRootNode");        
        var f_node = r_node.findFirst(instrument)

        console.log(f_node)
        $( "#stream-select" ).empty();
        $( "#variable-select" ).empty();
        global_f_node = f_node;


        if (f_node.getChildren().length>0){
            for (var i = 0; i < f_node.getChildren().length; i++) {
                console.log("My brotha!");
                 console.log(f_node.getChildren()[i].title);
                 $( "#stream-select" ).append('<option value="'+f_node.getChildren()[i].title+'">'+f_node.getChildren()[i].title+'</option>')
                if (i==0){
                    param_list = f_node.getChildren()[i].getChildren()
                    for (var j = 0; j < param_list.length; j++) {
                        if (param_list[j].title.indexOf("time") == -1){
                        $( "#variable-select" ).append('<option value="'+param_list[j].title+'">'+param_list[j].title+'</option>')
                        }
                    };
                } 
            };
        }


        $( "#currentArray" ).text(array);
        $( "#currentPlatform" ).text(platform);
        $( "#currentInstrument" ).text(instrument);      

        getTimeCoverage(array,platform,instrument);  // Also updates the data because it sets the date picker
    });

    $( "#variable-select" ).change(function() {
       updateDataPlot();
    });    

    //DATE TIME FUNCTION
    $(function () {
            $('#datetimepicker_from').datetimepicker();
            $('#datetimepicker_to').datetimepicker();
            
            $('#datetimepicker_from').data("DateTimePicker").setDate(new Date("jul 15, 2014"))

            $('#datetimepicker_to').data("DateTimePicker").setDate(new Date("jul 20, 2014"))

            $("#datetimepicker_from").on("dp.change",function (e) {
               $('#datetimepicker_to').data("DateTimePicker").setMinDate(e.date);
               updateDataPlot();
            });
            $("#datetimepicker_to").on("dp.change",function (e) {
               $('#datetimepicker_from').data("DateTimePicker").setMaxDate(e.date);
               updateDataPlot();
            });
    });


    function updateDataPlot(){
        array = $( "#currentArray" ).text();
        platform = $( "#currentPlatform" ).text();
        instrument = $( "#currentInstrument" ).text();   
        
        updateData(array,platform,instrument); 
    }

    var global_f_node = null;
    </script>

</body>
</html>
